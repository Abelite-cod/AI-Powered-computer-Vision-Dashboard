<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Live Monitoring Dashboard</title>
  <style>
    body {
      margin: 0;
      background: #111;
      overflow: hidden;
    }

    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    #stream {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #0f0;
      font-family: monospace;
      font-size: 14px;
      background: rgba(0,0,0,0.6);
      padding: 6px 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div id="container">
  <!-- MJPEG Stream -->
  <img
    id="stream"
    src="http://127.0.0.1:8000/api/stream"
    alt="Live Stream"
  />

  <!-- Overlay Canvas -->
  <canvas id="overlay"></canvas>

  <div id="status">ðŸŸ¢ Connecting...</div>
</div>

<script>
const stream = document.getElementById("stream");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");
const status = document.getElementById("status");

// Resize canvas to match stream
function resizeCanvas() {
  canvas.width = stream.clientWidth;
  canvas.height = stream.clientHeight;
}
window.addEventListener("resize", resizeCanvas);
stream.onload = resizeCanvas;

// WebSocket (detections only)
const ws = new WebSocket("ws://127.0.0.1:8000/ws/detections");

ws.onopen = () => {
  status.textContent = "ðŸŸ¢ WebSocket Connected";
};

ws.onclose = () => {
  status.textContent = "ðŸ”´ WebSocket Disconnected";
};

ws.onerror = () => {
  status.textContent = "âŒ WebSocket Error";
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  const detections = data.detections || [];

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.lineWidth = 2;
  ctx.font = "14px Arial";

  detections.forEach(det => {
    const [x1, y1, x2, y2] = det.bbox;

    ctx.strokeStyle = "#00ff00";
    ctx.fillStyle = "#00ff00";

    ctx.strokeRect(
      x1,
      y1,
      x2 - x1,
      y2 - y1
    );

    ctx.fillText(
      `${det.class_name} [ID:${det.track_id}]`,
      x1,
      y1 - 6
    );
  });
};

// Cleanup
window.onbeforeunload = () => ws.close();
</script>

</body>
</html>
